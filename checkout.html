<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mealar Checkout</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: #fafafa;
      color: #222;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    .card {
      text-align: center;
      background: #fff;
      padding: 24px 28px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      max-width: 420px;
      width: 90%;
    }
    h2 { color: #F4A261; margin-top: 0; }
    button {
      margin-top: 16px;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      background: #F4A261;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="card" id="root">
    <h2>Processing Paymentâ€¦</h2>
    <p id="message">Please wait while we open Razorpay Checkout.</p>
  </div>

  <script>
    (function () {
      const qs = new URLSearchParams(location.search);
      const order_id = qs.get("order_id");
      const key_id = qs.get("key_id");
      const root = document.getElementById("root");

      function showMessage(title, text, color = "#333") {
        root.innerHTML = `
          <h2 style="color:${color}">${title}</h2>
          <p>${text}</p>
          <button onclick="window.close()">Close</button>
          <p style="font-size:13px;color:#666;margin-top:8px;">
            If this doesn't close automatically, you can safely close this tab.
          </p>
        `;
      }

      if (!order_id || !key_id) {
        showMessage("Invalid Request", "Missing order_id or key_id in URL.", "#b91c1c");
        return;
      }

      if (typeof Razorpay === "undefined") {
        showMessage("Error", "Failed to load Razorpay Checkout script.", "#b91c1c");
        return;
      }

      const options = {
        key: key_id,
        order_id: order_id,
        name: "Mealar",
        description: "Wallet Top-up",
        theme: { color: "#F4A261" },
        prefill: {
          name: "Mealar User",
          email: "test@example.com",
          contact: "9999999999"
        },
        // ðŸ”¹ Try to keep only UPI visible / preferred
        method: {
          upi: true,
          card: true,
          netbanking: true,
          wallet: false,
          emi: false,
          paylater: false
        },
        config: {
          display: {
            hide: ["wallet", "emi", "paylater"]
          }
        },
        handler: function (response) {
          const payload = {
            type: "payment_success",
            source: "checkout_html",
            order_id: response.razorpay_order_id || order_id,
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_signature: response.razorpay_signature || null
          };

          // âœ… Notify React Native WebView (in-app flow)
          try {
            if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
              window.ReactNativeWebView.postMessage(JSON.stringify(payload));
            }
          } catch (e) {
            console.log("postMessage to RN failed", e);
          }

          // ðŸ” Fallback deep-link (for when opened in external browser)
          try {
            const deeplink =
              "mealar://payment-success?order_id=" +
              encodeURIComponent(payload.order_id || "") +
              "&payment_id=" +
              encodeURIComponent(payload.razorpay_payment_id || "");
            window.location.href = deeplink;
          } catch (e) {}

          // UI fallback
          setTimeout(() => {
            showMessage("Payment Successful", "You may now close this window.", "#166534");
          }, 2000);
        },
        modal: {
          ondismiss: function () {
            try {
              if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
                window.ReactNativeWebView.postMessage(
                  JSON.stringify({ type: "payment_error", reason: "user_cancelled" })
                );
              }
            } catch (e) {}
            showMessage("Payment Cancelled", "You closed the payment window.", "#b91c1c");
          }
        }
      };

      try {
        const rzp = new Razorpay(options);
        rzp.open();
      } catch (err) {
        console.error("Razorpay open error", err);
        showMessage("Error", "Unable to open Razorpay Checkout.", "#b91c1c");
      }
    })();
  </script>
</body>
</html>
